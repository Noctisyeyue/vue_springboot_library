# Oracle数据库表结构设计（保持原字段名）

## 1. 用户表 (user)

| 字段名 | 数据类型 | 约束 | 说明 |
|--------|----------|------|------|
| id | NUMBER(19) | **PRIMARY KEY** | ID |
| username | VARCHAR2(255) | **UNIQUE NOT NULL** | 用户名 |
| password | VARCHAR2(255) | **NOT NULL** | 密码 |
| nick_name | VARCHAR2(255) |  | 姓名 |
| phone | VARCHAR2(255) | **UNIQUE** | 电话号码 |
| sex | VARCHAR2(255) |  | 性别 |
| address | VARCHAR2(255) |  | 地址 |
| role | NUMBER(10) | **NOT NULL** | 角色、1：管理员 2：普通用户 |


**序列和触发器：**
```sql
CREATE SEQUENCE seq_user_id START WITH 1 INCREMENT BY 1;

CREATE OR REPLACE TRIGGER trg_user_bi
BEFORE INSERT ON user
FOR EACH ROW
BEGIN
  IF :NEW.id IS NULL THEN
    SELECT seq_user_id.NEXTVAL INTO :NEW.id FROM dual;
  END IF;
  
  IF :NEW.create_time IS NULL THEN
    :NEW.create_time := SYSTIMESTAMP;
  END IF;
END;
```

## 2. 图书表 (book)

| 字段名 | 数据类型 | 约束 | 说明 |
|--------|----------|------|------|
| id | NUMBER(19) | **PRIMARY KEY** | id |
| isbn | VARCHAR2(255) | **UNIQUE NOT NULL** | 图书编号 |
| name | VARCHAR2(255) |  | 名称 |
| price | NUMBER(10,2) |  | 价格 |
| author | VARCHAR2(255) |  | 作者 |
| publisher | VARCHAR2(255) |  | 出版社 |
| create_time | DATE |  | 出版时间 |
| book_picture | VARCHAR2(200) |  | 图片 |
| status | VARCHAR2(1) | **NOT NULL** | 0：不可借阅 1：可借阅 |
| borrow_num | NUMBER(10) | **NOT NULL DEFAULT 0** | 此书被借阅次数 |
| total_quantity | NUMBER(10) | **NOT NULL DEFAULT 1** | 图书总数量 |
| borrowed_quantity | NUMBER(10) | **NOT NULL DEFAULT 0** | 已借阅数量 |


**序列和触发器：**
```sql
CREATE SEQUENCE seq_book_id START WITH 1 INCREMENT BY 1;

CREATE OR REPLACE TRIGGER trg_book_bi
BEFORE INSERT ON book
FOR EACH ROW
BEGIN
  IF :NEW.id IS NULL THEN
    SELECT seq_book_id.NEXTVAL INTO :NEW.id FROM dual;
  END IF;
END;

CREATE OR REPLACE TRIGGER trg_book_bu
BEFORE UPDATE ON book
FOR EACH ROW
BEGIN
  :NEW.update_time := SYSTIMESTAMP;
END;
```

## 3. 当前借阅表 (bookwithuser)

| 字段名 | 数据类型 | 约束 | 说明 |
|--------|----------|------|------|
| record_id | NUMBER(19) | **PRIMARY KEY** | 借阅记录ID（主键） |
| reader_id | NUMBER(19) | **FOREIGN KEY REFERENCES user(id)** | 读者id |
| book_id | NUMBER(19)  | **FOREIGN KEY REFERENCES book(id)** | 图书id |
| lend_time | TIMESTAMP |  | 借阅时间 |
| dead_time | TIMESTAMP |  | 应归还时间 |
| prolong | NUMBER(10) |  | 续借次数 |

**外键约束：**
```sql
ALTER TABLE bookwithuser ADD CONSTRAINT fk_bookwithuser_user
FOREIGN KEY (reader_id) REFERENCES user(id);

ALTER TABLE bookwithuser ADD CONSTRAINT fk_bookwithuser_book
FOREIGN KEY (book_id) REFERENCES book(id);
```

**序列和触发器：**
```sql
CREATE SEQUENCE seq_bookwithuser_id START WITH 1 INCREMENT BY 1;

CREATE OR REPLACE TRIGGER trg_bookwithuser_bi
BEFORE INSERT ON bookwithuser
FOR EACH ROW
BEGIN
  IF :NEW.record_id IS NULL THEN
    SELECT seq_bookwithuser_id.NEXTVAL INTO :NEW.record_id FROM dual;
  END IF;
END;
```

## 4. 借阅历史表 (lend_record)

| 字段名 | 数据类型 | 约束 | 说明 |
|--------|----------|------|------|
| reader_id | NUMBER(19) | **FOREIGN KEY REFERENCES user(id)** | 读者id |
| book_id | NUMBER(19)  | **FOREIGN KEY REFERENCES book(id)** | 图书id |
| lend_time | TIMESTAMP |  | 借书日期 |
| return_time | TIMESTAMP |  | 还书日期 |
| status | VARCHAR2(1) |  | 0：未归还 1：已归还 |


**主键约束：**
```sql
ALTER TABLE lend_record ADD CONSTRAINT pk_lend_record
PRIMARY KEY (reader_id, isbn, lend_time);
```

**外键约束：**
```sql
ALTER TABLE lend_record ADD CONSTRAINT fk_lendrecord_user
FOREIGN KEY (reader_id) REFERENCES user(id);

ALTER TABLE lend_record ADD CONSTRAINT fk_lendrecord_book
FOREIGN KEY (book_id) REFERENCES book(id);
```

## 5. 图书收藏表 (book_collection)

| 字段名 | 数据类型 | 约束 | 说明 |
|--------|----------|------|------|
| id | NUMBER(19) | **PRIMARY KEY** | 收藏记录ID |
| reader_id | NUMBER(19) | **FOREIGN KEY REFERENCES user(id)** | 读者ID |
| book_id | NUMBER(19) | **FOREIGN KEY REFERENCES book(id)** | 图书ID |
| collection_time | TIMESTAMP | **DEFAULT SYSTIMESTAMP** | 收藏时间 |

**复合唯一约束：**
```sql
ALTER TABLE book_collection ADD CONSTRAINT uk_user_book 
UNIQUE (reader_id, book_id);
```

**外键约束：**
```sql
ALTER TABLE book_collection ADD CONSTRAINT fk_collection_user
FOREIGN KEY (reader_id) REFERENCES user(id);

ALTER TABLE book_collection ADD CONSTRAINT fk_collection_book
FOREIGN KEY (book_id) REFERENCES book(id);
```

**序列和触发器：**
```sql
CREATE SEQUENCE seq_collection_id START WITH 1 INCREMENT BY 1;

CREATE OR REPLACE TRIGGER trg_collection_bi
BEFORE INSERT ON book_collection
FOR EACH ROW
BEGIN
  IF :NEW.id IS NULL THEN
    SELECT seq_collection_id.NEXTVAL INTO :NEW.id FROM dual;
  END IF;
END;
```

## 6. 访问统计表 (visit_stats)

| 字段名 | 数据类型 | 约束 | 说明 |
|--------|----------|------|------|
| id | NUMBER(10) | **PRIMARY KEY** | 主键ID |
| total_visits | NUMBER(19) | **NOT NULL DEFAULT 0** | 总访问量 |