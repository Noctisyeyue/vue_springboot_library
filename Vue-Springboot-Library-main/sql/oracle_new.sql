-- 图书管理系统数据库创建脚本 (Oracle 21c XE)
-- 数据库名: library
-- 用于存储图书馆管理系统中的图书、用户和借阅记录

-- 1. 创建用户表 (user) - 使用双引号避免关键字冲突
DROP TABLE "user" CASCADE CONSTRAINTS;

CREATE TABLE "user" (
    id NUMBER(19) GENERATED BY DEFAULT AS IDENTITY 
        (START WITH 1 INCREMENT BY 1 NOCACHE NOCYCLE) PRIMARY KEY,
    username VARCHAR2(255) NOT NULL UNIQUE,
    password VARCHAR2(255) NOT NULL,
    nick_name VARCHAR2(255),
    phone VARCHAR2(255) UNIQUE,
    sex VARCHAR2(255),
    address VARCHAR2(255),
    role NUMBER(10) NOT NULL,
    CONSTRAINT chk_user_role CHECK (role IN (1, 2))
);

-- 2. 创建图书表 (book)
DROP TABLE book CASCADE CONSTRAINTS;

CREATE TABLE book (
    id NUMBER(19) GENERATED BY DEFAULT AS IDENTITY 
        (START WITH 1 INCREMENT BY 1 NOCACHE NOCYCLE) PRIMARY KEY,
    isbn VARCHAR2(255) NOT NULL UNIQUE,
    name VARCHAR2(255),
    price NUMBER(10,2),
    author VARCHAR2(255),
    publisher VARCHAR2(255),
    create_time DATE,
    book_picture VARCHAR2(200),
    status VARCHAR2(1) DEFAULT '1' NOT NULL,
    borrow_num NUMBER(10) DEFAULT 0 NOT NULL,
    total_quantity NUMBER(10) DEFAULT 1 NOT NULL,
    borrowed_quantity NUMBER(10) DEFAULT 0 NOT NULL,
    CONSTRAINT chk_book_status CHECK (status IN ('0', '1')),
    CONSTRAINT chk_book_quantity CHECK (borrowed_quantity <= total_quantity)
);

-- 3. 创建当前借阅表 (bookwithuser)
DROP TABLE bookwithuser CASCADE CONSTRAINTS;

CREATE TABLE bookwithuser (
    record_id NUMBER(19) GENERATED BY DEFAULT AS IDENTITY 
        (START WITH 1 INCREMENT BY 1 NOCACHE NOCYCLE) PRIMARY KEY,
    reader_id NUMBER(19) NOT NULL,
    book_id NUMBER(19) NOT NULL,
    lend_time TIMESTAMP DEFAULT SYSTIMESTAMP,
    dead_time TIMESTAMP,
    prolong NUMBER(10) DEFAULT 0,
    CONSTRAINT fk_bookwithuser_reader FOREIGN KEY (reader_id) REFERENCES "user"(id),
    CONSTRAINT fk_bookwithuser_book FOREIGN KEY (book_id) REFERENCES book(id)
);

-- 4. 创建借阅历史表 (lend_record)
-- 注意：联合主键包含读者ID、图书ID和借阅时间
DROP TABLE lend_record CASCADE CONSTRAINTS;

CREATE TABLE lend_record (
    reader_id NUMBER(19) NOT NULL,
    book_id NUMBER(19) NOT NULL,
    lend_time TIMESTAMP NOT NULL,
    return_time TIMESTAMP,
    status VARCHAR2(1) DEFAULT '0',
    CONSTRAINT pk_lend_record PRIMARY KEY (reader_id, book_id, lend_time),
    CONSTRAINT fk_lend_record_reader FOREIGN KEY (reader_id) REFERENCES "user"(id),
    CONSTRAINT fk_lend_record_book FOREIGN KEY (book_id) REFERENCES book(id),
    CONSTRAINT chk_lend_record_status CHECK (status IN ('0', '1'))
);

-- 5. 创建图书收藏表 (book_collection)
DROP TABLE book_collection CASCADE CONSTRAINTS;

CREATE TABLE book_collection (
    id NUMBER(19) GENERATED BY DEFAULT AS IDENTITY 
        (START WITH 1 INCREMENT BY 1 NOCACHE NOCYCLE) PRIMARY KEY,
    reader_id NUMBER(19) NOT NULL,
    book_id NUMBER(19) NOT NULL,
    collection_time TIMESTAMP DEFAULT SYSTIMESTAMP,
    CONSTRAINT fk_collection_reader FOREIGN KEY (reader_id) REFERENCES "user"(id),
    CONSTRAINT fk_collection_book FOREIGN KEY (book_id) REFERENCES book(id)
);

-- 6. 创建访问统计表 (visit_stats)
DROP TABLE visit_stats CASCADE CONSTRAINTS;

CREATE TABLE visit_stats (
    id NUMBER(10) GENERATED BY DEFAULT AS IDENTITY 
        (START WITH 1 INCREMENT BY 1 NOCACHE NOCYCLE) PRIMARY KEY,
    total_visits NUMBER(19) DEFAULT 0 NOT NULL
);

-- 7. 创建索引提升查询性能

-- 用户表的username和phone已有UNIQUE约束，无需额外索引
-- CREATE INDEX idx_user_username ON "user"(username);  -- UNIQUE约束已包含索引
-- CREATE INDEX idx_user_phone ON "user"(phone);        -- UNIQUE约束已包含索引

-- 图书表的isbn已有UNIQUE约束，无需额外索引
-- CREATE INDEX idx_book_isbn ON book(isbn);            -- UNIQUE约束已包含索引
CREATE INDEX idx_book_status ON book(status);
CREATE INDEX idx_book_name ON book(name);
CREATE INDEX idx_book_author ON book(author);

-- 当前借阅表索引
CREATE INDEX idx_bookwithuser_reader ON bookwithuser(reader_id);
CREATE INDEX idx_bookwithuser_book ON bookwithuser(book_id);
CREATE INDEX idx_bookwithuser_deadtime ON bookwithuser(dead_time);

-- 借阅历史表索引
CREATE INDEX idx_lend_record_reader ON lend_record(reader_id);
CREATE INDEX idx_lend_record_book ON lend_record(book_id);
CREATE INDEX idx_lend_record_status ON lend_record(status);
CREATE INDEX idx_lend_record_lendtime ON lend_record(lend_time);
CREATE INDEX idx_lend_record_returntime ON lend_record(return_time);

-- 收藏表索引
CREATE INDEX idx_collection_reader ON book_collection(reader_id);
CREATE INDEX idx_collection_book ON book_collection(book_id);
CREATE INDEX idx_collection_time ON book_collection(collection_time);

-- 8. 插入测试数据

-- 插入用户数据
INSERT INTO "user" (id, username, password, nick_name, phone, sex, address, role) VALUES (1, 'admin', '123', '管理员', '13800138000', '男', '北京市朝阳区', 1);
INSERT INTO "user" (id, username, password, nick_name, phone, sex, address, role) VALUES (2, 'user1', '123', '张三', '13800138001', '男', '上海市浦东新区', 2);
INSERT INTO "user" (id, username, password, nick_name, phone, sex, address, role) VALUES (3, 'user2', '123456', '李四', '13800138002', '女', '广州市天河区', 2);
INSERT INTO "user" (id, username, password, nick_name, phone, sex, address, role) VALUES (4, 'user3', '123456', '王五', '13800138003', '男', '深圳市南山区', 2);
INSERT INTO "user" (id, username, password, nick_name, phone, sex, address, role) VALUES (5, 'user4', '123456', '赵六', '13800138004', '女', '杭州市西湖区', 2);

-- 插入图书数据
INSERT INTO book (id, isbn, name, price, author, publisher, create_time, status, borrow_num, total_quantity, borrowed_quantity) VALUES (1, '9787020002207', '红楼梦', 59.70, '曹雪芹', '人民文学出版社', TO_DATE('2008-06-01', 'YYYY-MM-DD'), '1', 15, 10, 2);
INSERT INTO book (id, isbn, name, price, author, publisher, create_time, status, borrow_num, total_quantity, borrowed_quantity) VALUES (2, '9787020002208', '西游记', 45.00, '吴承恩', '人民文学出版社', TO_DATE('2008-06-01', 'YYYY-MM-DD'), '1', 12, 8, 1);
INSERT INTO book (id, isbn, name, price, author, publisher, create_time, status, borrow_num, total_quantity, borrowed_quantity) VALUES (3, '9787020002209', '水浒传', 52.30, '施耐庵', '人民文学出版社', TO_DATE('2008-06-01', 'YYYY-MM-DD'), '1', 10, 6, 0);
INSERT INTO book (id, isbn, name, price, author, publisher, create_time, status, borrow_num, total_quantity, borrowed_quantity) VALUES (4, '9787020002210', '三国演义', 48.90, '罗贯中', '人民文学出版社', TO_DATE('2008-06-01', 'YYYY-MM-DD'), '1', 18, 12, 3);
INSERT INTO book (id, isbn, name, price, author, publisher, create_time, status, borrow_num, total_quantity, borrowed_quantity) VALUES (5, '9787108005460', '围城', 39.50, '钱钟书', '人民文学出版社', TO_DATE('2010-01-01', 'YYYY-MM-DD'), '1', 8, 5, 1);
INSERT INTO book (id, isbn, name, price, author, publisher, create_time, status, borrow_num, total_quantity, borrowed_quantity) VALUES (6, '9787020024759', '活着', 35.00, '余华', '作家出版社', TO_DATE('2012-08-01', 'YYYY-MM-DD'), '1', 20, 15, 4);
INSERT INTO book (id, isbn, name, price, author, publisher, create_time, status, borrow_num, total_quantity, borrowed_quantity) VALUES (7, '9787530215009', '百年孤独', 55.00, '加西亚·马尔克斯', '南海出版公司', TO_DATE('2017-08-01', 'YYYY-MM-DD'), '1', 6, 4, 0);
INSERT INTO book (id, isbn, name, price, author, publisher, create_time, status, borrow_num, total_quantity, borrowed_quantity) VALUES (8, '9787020093456', '挪威的森林', 42.00, '村上春树', '人民文学出版社', TO_DATE('2018-03-01', 'YYYY-MM-DD'), '1', 9, 7, 2);
INSERT INTO book (id, isbn, name, price, author, publisher, create_time, status, borrow_num, total_quantity, borrowed_quantity) VALUES (9, '9787506347168', '小王子', 22.00, '安托万·德·圣埃克苏佩里', '人民文学出版社', TO_DATE('2003-08-01', 'YYYY-MM-DD'), '1', 25, 20, 5);
INSERT INTO book (id, isbn, name, price, author, publisher, create_time, status, borrow_num, total_quantity, borrowed_quantity) VALUES (10, '9787544217686', '追风筝的人', 36.00, '卡勒德·胡赛尼', '上海人民出版社', TO_DATE('2013-05-01', 'YYYY-MM-DD'), '1', 11, 8, 1);

-- 插入当前借阅数据（仅存储未还书的记录）
INSERT INTO bookwithuser (record_id, reader_id, book_id, lend_time, dead_time, prolong) VALUES (1, 3, 6, TO_TIMESTAMP('2024-12-02 14:20:00', 'YYYY-MM-DD HH24:MI:SS'), TO_TIMESTAMP('2024-12-16 14:20:00', 'YYYY-MM-DD HH24:MI:SS'), 0);
INSERT INTO bookwithuser (record_id, reader_id, book_id, lend_time, dead_time, prolong) VALUES (2, 4, 8, TO_TIMESTAMP('2024-12-03 09:15:00', 'YYYY-MM-DD HH24:MI:SS'), TO_TIMESTAMP('2024-12-17 09:15:00', 'YYYY-MM-DD HH24:MI:SS'), 0);
INSERT INTO bookwithuser (record_id, reader_id, book_id, lend_time, dead_time, prolong) VALUES (3, 5, 10, TO_TIMESTAMP('2024-12-03 16:45:00', 'YYYY-MM-DD HH24:MI:SS'), TO_TIMESTAMP('2024-12-17 16:45:00', 'YYYY-MM-DD HH24:MI:SS'), 2);

-- 插入借阅历史数据（包含所有历史记录，已还和未还）
INSERT INTO lend_record (reader_id, book_id, lend_time, return_time, status) VALUES (2, 1, TO_TIMESTAMP('2024-11-01 10:30:00', 'YYYY-MM-DD HH24:MI:SS'), TO_TIMESTAMP('2024-11-15 14:20:00', 'YYYY-MM-DD HH24:MI:SS'), '1');
INSERT INTO lend_record (reader_id, book_id, lend_time, return_time, status) VALUES (2, 2, TO_TIMESTAMP('2024-10-15 09:00:00', 'YYYY-MM-DD HH24:MI:SS'), TO_TIMESTAMP('2024-10-29 16:30:00', 'YYYY-MM-DD HH24:MI:SS'), '1');
INSERT INTO lend_record (reader_id, book_id, lend_time, return_time, status) VALUES (2, 5, TO_TIMESTAMP('2024-11-10 11:15:00', 'YYYY-MM-DD HH24:MI:SS'), TO_TIMESTAMP('2024-11-24 10:45:00', 'YYYY-MM-DD HH24:MI:SS'), '1');
INSERT INTO lend_record (reader_id, book_id, lend_time, return_time, status) VALUES (3, 3, TO_TIMESTAMP('2024-11-05 14:30:00', 'YYYY-MM-DD HH24:MI:SS'), TO_TIMESTAMP('2024-11-19 15:20:00', 'YYYY-MM-DD HH24:MI:SS'), '1');
INSERT INTO lend_record (reader_id, book_id, lend_time, return_time, status) VALUES (3, 6, TO_TIMESTAMP('2024-12-02 14:20:00', 'YYYY-MM-DD HH24:MI:SS'), NULL, '0');
INSERT INTO lend_record (reader_id, book_id, lend_time, return_time, status) VALUES (4, 4, TO_TIMESTAMP('2024-11-20 08:45:00', 'YYYY-MM-DD HH24:MI:SS'), TO_TIMESTAMP('2024-12-04 09:30:00', 'YYYY-MM-DD HH24:MI:SS'), '1');
INSERT INTO lend_record (reader_id, book_id, lend_time, return_time, status) VALUES (4, 7, TO_TIMESTAMP('2024-10-25 13:15:00', 'YYYY-MM-DD HH24:MI:SS'), TO_TIMESTAMP('2024-11-08 14:00:00', 'YYYY-MM-DD HH24:MI:SS'), '1');
INSERT INTO lend_record (reader_id, book_id, lend_time, return_time, status) VALUES (4, 8, TO_TIMESTAMP('2024-12-03 09:15:00', 'YYYY-MM-DD HH24:MI:SS'), NULL, '0');
INSERT INTO lend_record (reader_id, book_id, lend_time, return_time, status) VALUES (5, 9, TO_TIMESTAMP('2024-11-08 15:30:00', 'YYYY-MM-DD HH24:MI:SS'), TO_TIMESTAMP('2024-11-22 16:15:00', 'YYYY-MM-DD HH24:MI:SS'), '1');
INSERT INTO lend_record (reader_id, book_id, lend_time, return_time, status) VALUES (5, 10, TO_TIMESTAMP('2024-12-03 16:45:00', 'YYYY-MM-DD HH24:MI:SS'), NULL, '0');

-- 插入收藏数据
INSERT INTO book_collection (id, reader_id, book_id, collection_time) VALUES (1, 2, 1, TO_TIMESTAMP('2024-11-01 11:00:00', 'YYYY-MM-DD HH24:MI:SS'));
INSERT INTO book_collection (id, reader_id, book_id, collection_time) VALUES (2, 2, 3, TO_TIMESTAMP('2024-11-10 15:30:00', 'YYYY-MM-DD HH24:MI:SS'));
INSERT INTO book_collection (id, reader_id, book_id, collection_time) VALUES (3, 3, 4, TO_TIMESTAMP('2024-11-05 16:20:00', 'YYYY-MM-DD HH24:MI:SS'));
INSERT INTO book_collection (id, reader_id, book_id, collection_time) VALUES (4, 3, 7, TO_TIMESTAMP('2024-11-06 09:15:00', 'YYYY-MM-DD HH24:MI:SS'));
INSERT INTO book_collection (id, reader_id, book_id, collection_time) VALUES (5, 4, 2, TO_TIMESTAMP('2024-11-20 10:45:00', 'YYYY-MM-DD HH24:MI:SS'));
INSERT INTO book_collection (id, reader_id, book_id, collection_time) VALUES (6, 4, 9, TO_TIMESTAMP('2024-11-21 14:30:00', 'YYYY-MM-DD HH24:MI:SS'));
INSERT INTO book_collection (id, reader_id, book_id, collection_time) VALUES (7, 5, 6, TO_TIMESTAMP('2024-11-25 13:20:00', 'YYYY-MM-DD HH24:MI:SS'));
INSERT INTO book_collection (id, reader_id, book_id, collection_time) VALUES (8, 5, 8, TO_TIMESTAMP('2024-11-26 08:15:00', 'YYYY-MM-DD HH24:MI:SS'));
INSERT INTO book_collection (id, reader_id, book_id, collection_time) VALUES (9, 2, 10, TO_TIMESTAMP('2024-12-01 12:00:00', 'YYYY-MM-DD HH24:MI:SS'));
INSERT INTO book_collection (id, reader_id, book_id, collection_time) VALUES (10, 3, 5, TO_TIMESTAMP('2024-12-02 17:30:00', 'YYYY-MM-DD HH24:MI:SS'));

-- 插入访问统计数据
INSERT INTO visit_stats (id, total_visits) VALUES (1, 50);

-- 9. 提交事务
COMMIT;

